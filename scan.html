<!DOCTYPE html>
<html>
  <head>
    <title>Instascan</title>
    <script type="text/javascript" src="https://menu.cash/static/instascan.min.js?1"></script>
    <style>
      #preview {
         width: 100%;
         height: 100%;
         max-height: 100vh;
      }
      #switch {
         position: fixed;
         font-size: 30px;
         right: 20px;
         top: 20px;
      }
    </style>
  </head>
  <body>
    <video id="preview"></video>
    <button id="switch">other camera</button>
    <script type="text/javascript">
      let started = false;
      let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
      let currentCameraIdx = 1;
      document.getElementById('switch').addEventListener('click', function () {
          Instascan.Camera.getCameras().then(function (cameras) {
              currentCameraIdx = (currentCameraIdx + 1) % cameras.length;
              switchTo(currentCameraIdx);
          }); 
      });
      scanner.addListener('scan', function (content) {
          location.href = '/subscribe/' + content;
      });
      function switchTo(cameraIdx) {
        var stoppedPromise = started ? scanner.stop() : new Promise(function(r) {r()});
        Instascan.Camera.getCameras().then(function (cameras) {
          if (cameras.length > 0) {
            stoppedPromise.then(function () {
               scanner.start(cameras[cameraIdx % cameras.length]);
            });
            started = true;
          } else {
            console.error('No cameras found.');
          }
        }).catch(function (e) {
          console.error(e);
        });
      }
      switchTo(currentCameraIdx);
    </script>
  </body>
</html>
